name: ELN GitHub Actions 3

on:
  push:
    branches: [ github-actions ]

  workflow_dispatch:

jobs:

  docker_container:
    runs-on: ubuntu-latest
    container: 
      image: complat/complat-ubuntu-runner:0.12.20
    services:
      postgres:
        image: postgres
        ports:
          - 5432:5432
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready 
          --health-interval 10s 
          --health-timeout 5s 
          --health-retries 5
    steps:
      - name: git clone
        working-directory: /home/gitlab-runner
        env:
          POSTGRES_HOST: postgres
          POSTGRES_PORT: 5432
          POSTGRES_DB: chemotion_test
          POSTGRES_USER: chemotion_test
          POSTGRES_PASSWORD: 123456
        run: |
            whoami
            sudo git clone --branch development --depth 1 https://github.com/ComPlat/chemotion_ELN.git 
            cd chemotion_ELN/config
            sudo cp database.yml.gitlab database.yml
            sudo cp -f storage.yml.example storage.yml
            sudo touch datacollectors.yml
            sudo cp -f profile_default.yml.example profile_default.yml
            sudo touch klasses.json
            echo "POSTGRES"
            psql -d postgresql://postgres:postgres@postgres/postgres -c "\du"
            psql -d postgresql://postgres:postgres@postgres/postgres -c "CREATE ROLE chemotion_test LOGIN CREATEDB SUPERUSER PASSWORD '123456'"
            psql -d postgresql://postgres:postgres@postgres/postgres -c "CREATE DATABASE chemotion_test OWNER chemotion_test;"
            psql -d postgresql://chemotion_test:123456@postgres/chemotion_test -c 'CREATE EXTENSION IF NOT EXISTS "pg_trgm"; CREATE EXTENSION IF NOT EXISTS "hstore";  CREATE EXTENSION IF NOT EXISTS "uuid-ossp";'
            psql -d postgresql://chemotion_test:123456@postgres/chemotion_test -c "\du"
            # which psql
            # psql --version
            # # echo "RAM"
            # # free -g
            # #/etc/init.d/postgresql status
            # # error 3
            # #/etc/init.d/postgresql start
            # #echo "SUDOERS"
            # #sudo cat /etc/sudoers
            # # sudo -Hu postgres pg_ctlcluster 12 main status
