# This docker-compose file sets up the dev environment.
# It builds an app container based on Dockerfile.chemotion.dev
#
# USAGE:
# The docker compose command should be apply with the following args
#      docker compose -f docker-compose.dev.yml --env-file .dockerenv
#
# docker_cmd="docker compose -f docker-compose.dev.yml --env-file .dockerenv "
#
# - Build the dev image with mapping to the current user and group ids:
#     gid=$(id -g) uid=$(id -u) ${docker_cmd} build setup
#
# - Run development environment:
#     ${docker_cmd} up -d
#
# - Open a bash shell in the app container:
#     ${docker_cmd} app bash
#
# - Run tests:
#     ${docker_cmd} app bundle exec rspec
#     ${docker_cmd} app yarn test
#
# - see .dockerenv.example for environment variables usage
#

x-common-volumes: &common-volumes
  - homedir:/home/ubuntu
  - .:/home/ubuntu/app

x-common-build: &common-build
  context: '.'
  dockerfile: 'Dockerfile.chemotion-dev'
  args:
    uid: ${uid:-default}
    gid: ${gid:-default}

x-common-image:
  - &chemotion_eln_dev ${DOCKER_DEV_IMAGE:-chemotion_eln_dev}

services:
  setup:
    build: *common-build
    image: *chemotion_eln_dev
    volumes: *common-volumes
    working_dir: "/home/ubuntu/app"
    command: "./prepare-ruby-dev.sh"

  postgres:
    image: ${DOCKER_PG_IMAGE:-postgres:16}
    environment:
      - 'POSTGRES_HOST_AUTH_METHOD=trust'
    command: >
      postgres
      -c wal_level=logical
      -c max_replication_slots=4
      -c max_wal_senders=4
    expose: # expose port to app container
      - '5432'
    ports: # expose port to host machine in case we want to use external db gui tools
      - ${HOST_PORT_PG:-5432}:5432
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

    volumes:
      - database:/var/lib/postgresql/data

  app:
    image: *chemotion_eln_dev
    depends_on:
      setup:
        condition: service_completed_successfully
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "bundle", "check"] # exit 0 if all gems from Gemfile are installed, otherwise exit 1
      interval: 30s
      timeout: 10s
    env_file:
      - .env
    environment:
      - 'SHAKAPACKER_DEV_SERVER_HOST=webpacker'
      - 'SHAKAPACKER_DEV_SERVER_PORT=3035'
      - 'THOR_SILENCE_DEPRECATION=true'
      - RAKE_DB_MIGRATE=${RAKE_DB_MIGRATE:-never}
    ports: # expose default rails port to host machine
      - ${HOST_PORT_APP:-3000}:3000
    volumes: *common-volumes
    working_dir: "/home/ubuntu/app"
    command: "./run-ruby-dev.sh"
    networks:
      - default
      - chemotion

  webpacker:
    image: *chemotion_eln_dev
    depends_on:
      setup:
        condition: service_completed_successfully
      app:
        condition: service_healthy
    environment:
      - 'NODE_ENV=development'
      - 'SHAKAPACKER_DEV_SERVER_HOST=webpacker'
      - 'SHAKAPACKER_DEV_SERVER_PORT=3035'
    env_file:
      - .env
    # - .env.development
    volumes: *common-volumes
    ports: # expose webpacker dev server port to app container
      - ${HOST_PORT_WEBPACK:-3035}:3035
    expose:
      - '3035'
    working_dir: "/home/ubuntu/app"
    command: './run-js-dev.sh'

  storybook:
    depends_on:
      webpacker:
        condition: service_started
    image: *chemotion_eln_dev
    env_file:
      - ./.env
      #- ./.env.development
    volumes: *common-volumes
    ports: # expose storybook dev server port to host machine
      - "6006:6006"
    working_dir: "/home/ubuntu/app"
    command: 'yarn run storybook'

  sequin:
    build:
      context: .
      dockerfile: Dockerfile.sequin
    image: sequinstream/sequin:dev
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - PG_URL=postgresql://postgres@postgres:5432/sequin_dev
      - REDIS_URL=redis://redis:6379/0
      # Secrets MUST be provided via environment variables or an env file
      # (no hard-coded defaults). For production, use a secrets manager
      # or `.env.production` and never commit that file to git.
      - SECRET_KEY_BASE=${SECRET_KEY_BASE}
      - VAULT_KEY=${VAULT_KEY}
      - SENTRY_DSN=${SENTRY_DSN}
      - PHX_HOST=localhost
      - PORT=7376
      - SELF_HOSTED=${SELF_HOSTED:-true}
    ports:
      - "${HOST_PORT_SEQUIN:-7376}:7376"  # Sequin API/UI
    volumes:
      - sequin_data:/var/lib/sequin
    networks:
      - default
      - chemotion
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7376/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  redis:
    image: redis:7-alpine
    expose:
      - '6379'
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - chemotion

  opensearch:
    image: opensearchproject/opensearch:2.11.1
    environment:
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
      # Disable security plugin for dev environment
      - DISABLE_SECURITY_PLUGIN=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    ports:
      - "${HOST_PORT_OPENSEARCH:-9200}:9200"  # REST API
      - "${HOST_PORT_OPENSEARCH_PERF:-9600}:9600"  # Performance Analyzer
    expose:
      - '9200'
      - '9600'
    volumes:
      - opensearch_data:/usr/share/opensearch/data
    networks:
      - default
      - chemotion
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

volumes:
  database:
    name: ${VOLUME_NAME_DB:-chemotion_eln_database}
  homedir:
    name: ${VOLUME_NAME_HOMEDIR:-chemotion_eln_homedir}
  sequin_data:
    name: ${VOLUME_NAME_SEQUIN:-chemotion_eln_sequin_data}
  redis_data:
    name: ${VOLUME_NAME_REDIS:-chemotion_eln_redis_data}
  opensearch_data:
    name: ${VOLUME_NAME_OPENSEARCH:-chemotion_eln_opensearch_data}

networks:
  chemotion:
